{% extends "base.html" %}
{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">ğŸŠ {{ year }}å¹´åº¦æ¼è›‹æ€»ç»“æŠ¥å‘Š</h1>
        <a href="{{ url_for('index') }}" class="btn btn-secondary mt-2">è¿”å›ä¸»é¡µ</a>
    </div>
</div>

{% if no_data %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">æš‚æ— æ•°æ®</h4>
    <p>{{ year }}å¹´åº¦æš‚æ— æ¯”èµ›æ•°æ®ï¼Œè¯·å…ˆåˆ›å»ºä¸€äº›æ¯”èµ›å§ï¼</p>
</div>
{% else %}

<!-- åŸºç¡€ç»Ÿè®¡ -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">ğŸ“Š åŸºç¡€ç»Ÿè®¡</h3>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3 mb-3">
                <div class="border rounded p-3 bg-light">
                    <h2 class="text-primary mb-0">{{ total_matches }}</h2>
                    <p class="mb-0">æ€»æ¯”èµ›åœºæ¬¡</p>
                    <small class="text-muted">(å·²å®Œæˆ: {{ finished_matches_count }})</small>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="border rounded p-3 bg-light">
                    <h2 class="text-success mb-0">{{ total_rounds }}</h2>
                    <p class="mb-0">æ€»è½®æ¬¡</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="border rounded p-3 bg-light">
                    <h2 class="text-info mb-0">{{ unique_players }}</h2>
                    <p class="mb-0">å‚ä¸é€‰æ‰‹æ•°</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="border rounded p-3 bg-light">
                    <h2 class="text-warning mb-0">{{ total_participations }}</h2>
                    <p class="mb-0">å‚èµ›äººæ¬¡</p>
                </div>
            </div>
        </div>
        
        <h5 class="mt-4 mb-3">ğŸ“… æœˆåº¦æ¯”èµ›åˆ†å¸ƒ</h5>
        <div class="row">
            {% for month_data in monthly_data %}
            <div class="col-6 col-md-2 mb-2">
                <div class="text-center">
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ (month_data.count / total_matches * 100) if total_matches > 0 else 0 }}%"
                             aria-valuenow="{{ month_data.count }}" aria-valuemin="0" aria-valuemax="{{ total_matches }}">
                            <strong>{{ month_data.count }}</strong>
                        </div>
                    </div>
                    <small>{{ month_data.month }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if top_locations %}
        <h5 class="mt-4 mb-3">ğŸ“ çƒ­é—¨åœ°ç‚¹ TOP3</h5>
        <ol class="list-group list-group-numbered">
            {% for location, count in top_locations %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ location }}
                <span class="badge bg-primary rounded-pill">{{ count }} åœº</span>
            </li>
            {% endfor %}
        </ol>
        {% endif %}
        
        <div class="row mt-4">
            {% if earliest_match %}
            <div class="col-md-6 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h5 class="card-title">ğŸŒ… æ—©èµ·é¸Ÿå„¿</h5>
                        <p class="mb-1">
                            <strong>{{ earliest_match.time.strftime('%H:%M') }}</strong> å¼€å±€
                        </p>
                        <small class="text-muted">
                            {{ earliest_match.time.strftime('%Y-%m-%d') }} @ {{ earliest_match.location }}
                            <br>{{ earliest_match.player_count }}äººå±€
                        </small>
                        {% if earliest_players %}
                        <div class="mt-2">
                            <span class="badge bg-warning text-dark">å‚æˆ˜é€‰æ‰‹</span>
                            <div class="mt-1">
                                {% for player in earliest_players %}
                                <span class="badge bg-light text-dark me-1">{{ player.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if latest_match %}
            <div class="col-md-6 mb-3">
                <div class="card border-info">
                    <div class="card-body">
                        <h5 class="card-title">ğŸŒ™ æ·±å¤œç‰Œå±€</h5>
                        <p class="mb-1">
                            <strong>{{ latest_match.time.strftime('%H:%M') }}</strong> å¼€å±€
                        </p>
                        <small class="text-muted">
                            {{ latest_match.time.strftime('%Y-%m-%d') }} @ {{ latest_match.location }}
                            <br>{{ latest_match.player_count }}äººå±€
                        </small>
                        {% if latest_players %}
                        <div class="mt-2">
                            <span class="badge bg-info">å‚æˆ˜é€‰æ‰‹</span>
                            <div class="mt-1">
                                {% for player in latest_players %}
                                <span class="badge bg-light text-dark me-1">{{ player.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- è£èª‰æ¦œå• -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h3 class="mb-0">ğŸ† è£èª‰æ¦œå•</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% if top_scorer %}
            <div class="col-md-6 mb-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h4 class="card-title">ğŸ‘‘ å¹´åº¦ç§¯åˆ†ç‹</h4>
                        <h2 class="text-warning">{{ top_scorer[0] }}</h2>
                        <p class="mb-0">æ€»ç§¯åˆ†: <strong>{{ top_scorer[1]['total_score'] }}</strong></p>
                        <small class="text-muted">å‚èµ› {{ top_scorer[1]['matches'] }} åœº</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if top_win_rate %}
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h4 class="card-title">ğŸ”¥ å¹´åº¦èƒœç‡ç‹</h4>
                        <h2 class="text-success">{{ top_win_rate[0] }}</h2>
                        <p class="mb-0">èƒœç‡: <strong>{{ "%.2f"|format(top_win_rate[1]['wins'] / top_win_rate[1]['matches'] * 100) }}%</strong></p>
                        <small class="text-muted">{{ top_win_rate[1]['wins'] }} èƒœ / {{ top_win_rate[1]['matches'] }} åœºï¼ˆæœ€å°‘10åœºï¼‰</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if iron_man %}
            <div class="col-md-6 mb-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h4 class="card-title">ğŸ’ª é“äººå¥–</h4>
                        <h2 class="text-info">{{ iron_man[0] }}</h2>
                        <p class="mb-0">å‚èµ›: <strong>{{ iron_man[1]['matches'] }}</strong> åœº</p>
                        <small class="text-muted">æœ€å‹¤å¥‹çš„é€‰æ‰‹</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if best_partners %}
            <div class="col-md-6 mb-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h4 class="card-title">ğŸ¤ æœ€ä½³æ­æ¡£</h4>
                        <h2 class="text-primary">{{ best_partners[0][0] }} & {{ best_partners[0][1] }}</h2>
                        <p class="mb-0">èƒœç‡: <strong>{{ "%.2f"|format(best_partners[0][4] * 100) }}%</strong></p>
                        <small class="text-muted">{{ best_partners[0][3] }} èƒœ / {{ best_partners[0][2] }} åœºï¼ˆæœ€å°‘10åœºï¼‰</small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- {% if best_partners and best_partners|length > 1 %}
        <h5 class="mt-3 mb-3">æœ€ä½³æ­æ¡£æ¦œ</h5>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>é€‰æ‰‹1</th>
                    <th>é€‰æ‰‹2</th>
                    <th>åˆä½œåœºæ¬¡</th>
                    <th>èƒœåœº</th>
                    <th>èƒœç‡</th>
                </tr>
            </thead>
            <tbody>
                {% for partner in best_partners %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ partner[0] }}</td>
                    <td>{{ partner[1] }}</td>
                    <td>{{ partner[2] }}</td>
                    <td>{{ partner[3] }}</td>
                    <td><strong>{{ "%.2f"|format(partner[4] * 100) }}%</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %} -->
    </div>
</div>

<!-- ç‰Œåœºä¼ è¯´ -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark">
        <h3 class="mb-0">ğŸ¯ ç‰Œåœºä¼ è¯´</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% if first_place_king %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-warning text-center mb-0">
                    <h5>ğŸ¥‡ å¤´åæ”¶å‰²æœº</h5>
                    <h3>{{ first_place_king[0] }}</h3>
                    <p class="mb-0">è·å¾—ç¬¬ä¸€å <strong>{{ first_place_king[1]['first_place'] }}</strong> æ¬¡</p>
                </div>
            </div>
            {% endif %}
            
            {% if stable_player %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-info text-center mb-0">
                    <h5>ğŸ“Š ç¨³å®šè¾¾äºº</h5>
                    <h3>{{ stable_player[0] }}</h3>
                    <p class="mb-0">å‘æŒ¥æœ€ç¨³å®š</p>
                    <small class="text-muted">åæ¬¡æ³¢åŠ¨æœ€å°ï¼ˆæœ€å°‘10åœºï¼‰</small>
                </div>
            </div>
            {% endif %}
            
            {% if comeback_king %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-danger text-center mb-0">
                    <h5>ğŸ’ª å¤§å¿ƒè„é€‰æ‰‹</h5>
                    <h3>{{ comeback_king[0] }}</h3>
                    <p class="mb-0">ç¿»ç›˜ <strong>{{ comeback_king[1]['comebacks'] }}</strong> æ¬¡</p>
                    <small class="text-muted">ç»åœ°åå‡»</small>
                </div>
            </div>
            {% endif %}
            
            {% if runner_up %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-secondary text-center mb-0">
                    <h5>ğŸƒ é™ªè·‘è¾¾äºº</h5>
                    <h3>{{ runner_up[0] }}</h3>
                    <p class="mb-0">èƒœç‡: <strong>{{ "%.2f"|format(runner_up[1]['wins'] / runner_up[1]['matches'] * 100) }}%</strong></p>
                    <small class="text-muted">é‡åœ¨å‚ä¸ï¼ˆæœ€å°‘10åœºï¼‰</small>
                </div>
            </div>
            {% endif %}
            
            {% if lucky_charm %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-success text-center mb-0">
                    <h5>ğŸ² äººå½¢é”¦é²¤</h5>
                    <h3>{{ lucky_charm[0] }}</h3>
                    <p class="mb-0">é˜Ÿå‹buff: <strong class="text-success">+{{ "%.1f"|format(lucky_charm[1] * 100) }}%</strong></p>
                    <small class="text-muted">å’ŒTAæ­æ¡£èƒœç‡é£™å‡ï¼ˆæœ€å°‘10åœºï¼‰</small>
                </div>
            </div>
            {% endif %}
            
            {% if bad_luck_charm %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-dark text-center mb-0">
                    <h5>â˜ ï¸ é˜Ÿå‹å…‹æ˜Ÿ</h5>
                    <h3>{{ bad_luck_charm[0] }}</h3>
                    <p class="mb-0">é˜Ÿå‹debuff: <strong class="text-danger">{{ "%.1f"|format(bad_luck_charm[1] * 100) }}%</strong></p>
                    <small class="text-muted">åå‘é”¦é²¤ï¼ˆæœ€å°‘10åœºï¼‰</small>
                </div>
            </div>
            {% endif %}
            
            {% if rollercoaster_player %}
            <div class="col-md-4 mb-3">
                <div class="alert alert-primary text-center mb-0">
                    <h5>ğŸŒªï¸ è¿‡å±±è½¦ç©å®¶</h5>
                    <h3>{{ rollercoaster_player[0] }}</h3>
                    <p class="mb-0">å•åœºæœ€å¤§æ³¢åŠ¨: <strong>{{ rollercoaster_player[1]|int }}</strong> ä¸ªåæ¬¡</p>
                    <small class="text-muted">å¹³å‡æ³¢åŠ¨: {{ "%.1f"|format(rollercoaster_player[2]) }} åæ¬¡ï¼ˆæœ€å°‘10åœºï¼‰</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- è¿‡æ‹›è®°å½• -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-danger text-white">
        <h3 class="mb-0">ğŸ”¥ è¿‡æ‹›è®°å½•</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% if golden_partner %}
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸŒŸ é»„é‡‘æ­æ¡£</h5>
                        <h4>{{ golden_partner[0] }} & {{ golden_partner[1] }}</h4>
                        <p class="mb-0">
                            åˆä½œ {{ golden_partner[2] }} åœºï¼Œèƒœ {{ golden_partner[3] }} åœº
                            <br><strong class="text-success">èƒœç‡: {{ "%.2f"|format(golden_partner[4] * 100) }}%</strong>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if worst_partner %}
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ˜… å†¤å®¶å¯¹å¤´</h5>
                        <h4>{{ worst_partner[0] }} & {{ worst_partner[1] }}</h4>
                        <p class="mb-0">
                            åˆä½œ {{ worst_partner[2] }} åœºï¼Œèƒœ {{ worst_partner[3] }} åœº
                            <br><strong class="text-danger">èƒœç‡: {{ "%.2f"|format(worst_partner[4] * 100) }}%</strong>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if most_frequent_partner %}
            <div class="col-md-12 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ‘­ å§å¦¹æƒ…æ·±</h5>
                        <h4>{{ most_frequent_partner[0] }} & {{ most_frequent_partner[1] }}</h4>
                        <p class="mb-0">
                            æ­æ¡£ <strong>{{ most_frequent_partner[2] }}</strong> åœºï¼Œèƒœ {{ most_frequent_partner[3] }} åœº
                            <br><small class="text-muted">åˆä½œæ¬¡æ•°æœ€å¤šçš„ç»„åˆ</small>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if strongest_rivalry %}
            <div class="col-md-12 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">ğŸ”¥ æœ€å¼ºå®¿æ•Œ</h5>
                        <h4>{{ strongest_rivalry[0] }} vs {{ strongest_rivalry[1] }}</h4>
                        <p class="mb-0">å¯¹æˆ˜ <strong>{{ strongest_rivalry[2] }}</strong> åœºï¼ˆæœ€å°‘10åœºï¼‰</p>
                        <small class="text-muted">æ£‹é€¢å¯¹æ‰‹</small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- å¹´åº¦ä¹‹æœ€ -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
        <h3 class="mb-0">ğŸŒŸ å¹´åº¦ä¹‹æœ€</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% if max_score_player %}
            <div class="col-md-6 mb-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <h5 class="card-title">ğŸš€ å•åœºæœ€é«˜åˆ†</h5>
                        <h3 class="text-primary">{{ max_score_player }}</h3>
                        <p class="mb-1">ç§¯åˆ†: <strong>{{ max_single_score }}</strong></p>
                        {% if max_score_match %}
                        <small class="text-muted">
                            {{ max_score_match.time.strftime('%Y-%m-%d') }} 
                            @ {{ max_score_match.location }}
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if max_comeback_match and max_comeback > 0 %}
            <div class="col-md-6 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ”„ å•è½®æœ€å¤§ç¿»ç›˜</h5>
                        <h3 class="text-warning">{{ max_comeback }} åˆ†</h3>
                        <small class="text-muted">
                            {{ max_comeback_match.time.strftime('%Y-%m-%d') }} 
                            @ {{ max_comeback_match.location }}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if closest_match %}
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h5 class="card-title">âš¡ æœ€æ¿€çƒˆæ¯”èµ›</h5>
                        <h3 class="text-success">åˆ†å·®: {{ min_diff }}</h3>
                        <small class="text-muted">
                            {{ closest_match.time.strftime('%Y-%m-%d') }} 
                            @ {{ closest_match.location }}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if most_lopsided_match %}
            <div class="col-md-6 mb-3">
                <div class="card border-danger">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ’¥ æœ€æ‚¬æ®Šæ¯”èµ›</h5>
                        <h3 class="text-danger">åˆ†å·®: {{ max_diff }}</h3>
                        <small class="text-muted">
                            {{ most_lopsided_match.time.strftime('%Y-%m-%d') }} 
                            @ {{ most_lopsided_match.location }}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ”¶ç›Š/äºæŸæ¦œ -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h3 class="mb-0">ğŸ’° å¹´åº¦æ”¶ç›Šæ¦œ</h3>
    </div>
    <div class="card-body">
        <div class="row">
            {% if top_profit_maker %}
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ† æœ€å¤§èµ¢å®¶</h5>
                        <h3 class="text-success">{{ top_profit_maker[0] }}</h3>
                        <p class="mb-0">ç´¯è®¡æ”¶ç›Š: <strong class="text-success">+{{ top_profit_maker[1] }}</strong></p>
                        <small class="text-muted">è¿ç­¹å¸·å¹„ï¼Œå†³èƒœåƒé‡Œ</small>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if biggest_loser %}
            <div class="col-md-6 mb-3">
                <div class="card border-warning">
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“‰ æœ€å¤§è¾“å®¶</h5>
                        <h3 class="text-warning">{{ biggest_loser[0] }}</h3>
                        <p class="mb-0">ç´¯è®¡äºæŸ: <strong class="text-danger">{{ biggest_loser[1] }}</strong></p>
                        <small class="text-muted">èƒœè´¥ä¹ƒå…µå®¶å¸¸äº‹</small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        {% if profit_rankings %}
        <div class="row mt-3">
            <div class="col-12">
                <h5 class="mb-3">ğŸ“Š æ”¶ç›Šæ’è¡Œæ¦œ <span class="badge bg-info">88å°é¡¶</span></h5>
                <!-- <p class="text-muted small mb-3">
                    <em>ğŸ’¡ æ”¶ç›ŠæŒ‰ç…§88å°é¡¶è®¡ç®—</em>
                </p> -->
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%">æ’å</th>
                                <th style="width: 35%">é€‰æ‰‹</th>
                                <th style="width: 25%">ç´¯è®¡æ”¶ç›Š</th>
                                <th style="width: 25%">çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for name, profit in profit_rankings %}
                            <tr>
                                <td>
                                    {% if loop.index == 1 %}
                                        <span class="badge bg-warning text-dark">ğŸ¥‡ {{ loop.index }}</span>
                                    {% elif loop.index == 2 %}
                                        <span class="badge bg-secondary">ğŸ¥ˆ {{ loop.index }}</span>
                                    {% elif loop.index == 3 %}
                                        <span class="badge bg-info">ğŸ¥‰ {{ loop.index }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ loop.index }}</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ name }}</strong></td>
                                <td>
                                    {% if profit > 0 %}
                                        <span class="text-success fw-bold">+{{ profit }}</span>
                                    {% elif profit < 0 %}
                                        <span class="text-danger fw-bold">{{ profit }}</span>
                                    {% else %}
                                        <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if profit > 0 %}
                                        <span class="badge bg-success">ç›ˆåˆ©</span>
                                    {% elif profit < 0 %}
                                        <span class="badge bg-danger">äºæŸ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">æŒå¹³</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="text-center mb-4">
    <p class="text-muted">
        <em>æ•°æ®ç»Ÿè®¡æˆªè‡³ {{ year }}å¹´åº• Â· æ„Ÿè°¢æ‰€æœ‰å‚ä¸çš„é€‰æ‰‹ ğŸ‰</em>
    </p>
</div>

{% endif %}
{% endblock %}

